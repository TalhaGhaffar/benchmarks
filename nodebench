#!/bin/env python2.7

import argparse
import signal
import subprocess, sys, time, os
from itertools import ifilter
from random import seed, shuffle

parser = argparse.ArgumentParser(description="NodeBench benchmarking harness.")
parser.add_argument("-l", "--list-benchmarks", action="store_true",
                    dest="list_bencharks", help="list benchmarks")
parser.add_argument("-n", "--node-binary", dest="node_binary", 
                    help="node binary to use", default="node")
parser.add_argument("-b", "--benchmark", dest="benchmark")
parser.add_argument("-i", "--instrumentation", dest="instrumentation", default="")
parser.add_argument("-r", "--request-generator", dest="request_generator")
parser.add_argument("-m", "--mode", dest="mode", help="mode to replay clients", default="sequential")
parser.add_argument("-c", "--clients", dest="clients", help="number of clients", default=1, type=int)
parser.add_argument("-s", "--seed", dest ="seed", help="seed for client interleaving", default=7, type=int)
parser.add_argument("-o", "--order", dest ="order", help="client ordering", default="shuffled")

args = parser.parse_args()
node_binary = args.node_binary
benchmark = args.benchmark
instrumentation = args.instrumentation
mode = args.mode
clients = args.clients
iseed = args.seed
order = args.order

benchmark_registry = {
    "etherpad-lite" : { "startup_script" : "node_modules/ep_etherpad-lite/node/server.js"},
    "lets-chat" : { "startup_script" : "app.js" },
    "lighter" : { "startup_script" : "server.js" },
    "nodejs-todo" : { "startup_script" : "server.js" },
    "nodejs-mud" : { "startup_script" : "server.js" },
    "word-finder" : { "startup_script" : "server.js" },
}

basedir = os.getcwd()

print "benchmark is %s" % benchmark

benchmark_info = benchmark_registry[benchmark]
benchmark_dir = benchmark
startup_script = benchmark_info["startup_script"]

os.chdir(benchmark_dir)

node_run_cmd = "%s %s %s" % (instrumentation, node_binary, startup_script)
print node_run_cmd

node = subprocess.Popen(node_run_cmd, stdout=subprocess.PIPE, shell=True)
for line in iter(node.stdout.readline, ''):
    print line.strip("\r\n")
    if "BEGIN SENDING HTTP REQUESTS" in line:
        time.sleep(30)
	files = filter(lambda f: "_nodebench.py" in f, [d for d in os.listdir('.')])
        execfile(files[0]) # TODO make work for multiple files
        break

if mode == 'parallel':
    pass
    # p = Pool(num_threads)
    # p.map(single_client_execute, range(num_client))
else: # sequential by default
    if order == 'requests':
        queue = [ i for j in range(len(user_requests)) for i in range(clients) ]
    elif order == 'users':
        queue = [ i for i in range(clients) for j in range(len(user_requests)) ]
    elif order == 'shuffled':
        queue = [ i for i in range(clients) for j in range(len(user_requests)) ]
        seed(iseed) # do no remove this!
        shuffle(queue)
    print queue
    state = [ 0 for i in range(clients) ]
    for ID in queue:
        print ID
        while True:
            try:
                user_requests[state[ID]](ID)
                state[ID] += 1
                break
            except Exception, err:
                print Exception, err
                time.sleep(30)
                continue

assert all(s == len(user_requests) for s in state), "All requests did not execute"
node.send_signal(signal.SIGINT)
for line in iter(node.stdout.readline, ''):
    print line.strip("\r\n")

os.chdir(basedir)
